// backend/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Company {
  id           String    @id @default(cuid())
  externalId   String    @unique
  document     String?
  name         String
  legalName    String?
  obligations  String?
  raw          String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  processes    Process[]

  @@index([document])
}

model Process {
  id               String    @id @default(cuid())
  externalId       String
  companyId        String
  company          Company   @relation(fields: [companyId], references: [id])
  title            String
  department       String?
  description      String?
  statusRaw        String?
  statusNormalized String?
  progress         Float?
  startedAt        DateTime?
  finishedAt       DateTime?
  lastDh           DateTime?
  responsible      String?
  steps            String?
  history          String?
  attachments      String?
  raw              String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deliveries       Delivery[]

  @@unique([externalId])
  @@unique([companyId, externalId])
  @@index([statusNormalized])
  @@index([statusRaw])
  @@index([startedAt])
  @@index([finishedAt])
}

model Delivery {
  id           String    @id @default(cuid())
  externalId   String
  processId    String
  process      Process   @relation(fields: [processId], references: [id])
  type         String?
  description  String?
  statusRaw    String?
  occurredAt   DateTime?
  dueAt        DateTime?
  raw          String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([externalId])
  @@unique([processId, externalId])
  @@index([processId])
}

model SyncCursor {
  resource   String   @id
  cursor     String?
  lastRunAt  DateTime?
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())
}
